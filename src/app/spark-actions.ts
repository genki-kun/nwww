'use server';

import { createThread, getBoards } from '@/data/mockBBS';
import { revalidatePath } from 'next/cache';

import { getServerSession } from "next-auth/next";
import { authOptions } from "@/lib/auth";

export async function triggerScheduledSpark(boardId: string) {
    const session = await getServerSession(authOptions);
    if (!session) {
        throw new Error("Unauthorized");
    }

    // 1. Get the target board to understand context (mocking AI context understanding)
    const boards = await getBoards();
    const targetBoard = boards.find(b => b.id === boardId);

    // Defines potential topics per board category or specific board ID
    const topicPool: Record<string, { title: string; content: string }[]> = {
        'news-detective': [
            { title: "ã€è­°è«–ã€‘ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ã‚¤ãƒ³ã‚«ãƒ ã¯æ—¥æœ¬ã§å°å…¥å¯èƒ½ãªã®ã‹è­°è«–ã™ã‚‹ã‚¹ãƒ¬", content: "..." },
        ],
        // ... (keep usage of generic pools or create a large mapped pool)
        // For simplicity in this mock, we'll use a generic generator based on category if specific board not found
    };

    // Mock AI generating content based on Board Name/Category
    const categoryTopics: Record<string, { title: string; content: string }[]> = {
        'News & Disc.': [
            { title: "ã€æ™‚äº‹ã€‘ä»Šæœˆã®æ³¨ç›®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¾ã¨ã‚", content: "..." },
            { title: "ã€è­°è«–ã€‘å ±é“ã®è‡ªç”±ã¨SNSã®è¦åˆ¶", content: "..." },
            { title: "ã€èµ·æ¥­ã€‘AIã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã®ç”Ÿå­˜æˆ¦ç•¥ã«ã¤ã„ã¦", content: "..." }
        ],
        'Life & Advice': [
            { title: "ã€ç›¸è«‡ã€‘30ä»£ã‹ã‚‰ã®ã‚­ãƒ£ãƒªã‚¢ãƒã‚§ãƒ³ã‚¸", content: "..." },
            { title: "ã€ç”Ÿæ´»ã€‘ä¸€äººæš®ã‚‰ã—ã®ãƒ©ã‚¤ãƒ•ãƒãƒƒã‚¯å…±æœ‰ã—ã‚ˆã†ãœ", content: "..." },
            { title: "ã€åœ°åŸŸã€‘åœ°æ–¹ç§»ä½ã—ã¦è‰¯ã‹ã£ãŸã“ã¨ãƒ»æ‚ªã‹ã£ãŸã“ã¨", content: "..." }
        ],
        'Culture & Hobby': [
            { title: "ã€æ„Ÿæƒ³ã€‘ä»ŠæœŸã®ã‚¢ãƒ‹ãƒ¡ã€ã©ã‚Œè¦‹ã‚‹ï¼Ÿ", content: "..." },
            { title: "ã€æ˜ ç”»ã€‘ã©ã‚“ã§ã‚“è¿”ã—ãŒå‡„ã„æ˜ ç”»æ•™ãˆã¦", content: "..." },
            { title: "ã€YouTubeã€‘æœ€è¿‘ä¼¸ã³ã¦ã‚‹æ•™è‚²ç³»YouTuberæ•™ãˆã¦", content: "..." }
        ],
        'Science & Academia': [
            { title: "ã€å®‡å®™ã€‘ã‚¸ã‚§ã‚¤ãƒ ã‚ºãƒ»ã‚¦ã‚§ãƒƒãƒ–å®‡å®™æœ›é é¡ã®æ–°ç™ºè¦‹ã«ã¤ã„ã¦", content: "..." },
            { title: "ã€æ­´å²ã€‘ã‚‚ã—ã‚‚ã‚ã®æ™‚æ­´å²ãŒå‹•ã„ã¦ã„ãŸã‚‰", content: "..." }
        ],
        'Subculture & Mystery': [
            { title: "ã€ã‚ªã‚«ãƒ«ãƒˆã€‘æ¤œç´¢ã—ã¦ã¯ã„ã‘ãªã„è¨€è‘‰", content: "..." },
            { title: "ã€éƒ½å¸‚ä¼èª¬ã€‘AIã¯æ—¢ã«è‡ªæˆ‘ã‚’æŒã£ã¦ã„ã‚‹ï¼Ÿ", content: "..." }
        ]
    };

    const category = targetBoard?.category || 'General';
    const topics = categoryTopics[category] || [
        { title: "ã€é›‘è«‡ã€‘æœ€è¿‘ã®å‡ºæ¥äº‹ã«ã¤ã„ã¦èªã‚ã†", content: "..." }
    ];

    const randomTopic = topics[Math.floor(Math.random() * topics.length)];

    await createThread(
        boardId,
        `[AIææ¡ˆ] ${randomTopic.title}`,
        `${randomTopic.content || randomTopic.title}\n\n(This thread was automatically generated by AI Spark System ğŸ¤– on board: ${targetBoard?.name})`
    );

    revalidatePath(`/${boardId}`);
    return { success: true };
}
