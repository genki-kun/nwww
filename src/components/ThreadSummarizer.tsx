'use client';

import { useState, useEffect } from 'react';
import styles from './ThreadSummarizer.module.css';

// Auto-summarize thresholds
const SUMMARY_THRESHOLDS = [20, 50, 100, 200, 500];

interface ThreadSummarizerProps {
    threadId: string;
    initialSummary?: string;
    postCount: number;
}

export default function ThreadSummarizer({ threadId, initialSummary, postCount }: ThreadSummarizerProps) {
    const [summary, setSummary] = useState<string | null>(initialSummary || null);
    const [isLoading, setIsLoading] = useState(false);
    const [isOpen, setIsOpen] = useState(false);
    const [error, setError] = useState<string | null>(null);

    // Auto-trigger summarization when postCount hits a threshold
    useEffect(() => {
        if (postCount < 20) return; // Don't summarize below 20

        const shouldAutoSummarize = SUMMARY_THRESHOLDS.some(threshold =>
            postCount >= threshold && postCount < threshold + 5 // Within 5 posts of threshold
        );

        if (shouldAutoSummarize && !summary && !isLoading) {
            handleSummarize();
        }
    }, [postCount]);

    const handleSummarize = async () => {
        setIsLoading(true);
        setError(null);

        try {
            const res = await fetch('/api/thread/summarize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ threadId }),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.error || 'Failed to summarize');
            }

            const data = await res.json();
            setSummary(data.summary);
            setIsOpen(true);
        } catch (err: any) {
            console.error('Summarization error:', err);
            setError(err.message || 'è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        } finally {
            setIsLoading(false);
        }
    };

    // Don't render at all if less than 20 posts
    if (postCount < 20) {
        return null;
    }

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <h3 className={styles.title}>NWWWè¦ç´„ (3-Line Summary)</h3>
                <span className={styles.postCountBadge}>{postCount}ãƒ¬ã‚¹</span>
            </div>

            {/* Error State */}
            {error && (
                <div className={styles.action}>
                    <p className={styles.errorText}>{error}</p>
                    <button onClick={handleSummarize} className={styles.button}>
                        å†è©¦è¡Œ
                    </button>
                </div>
            )}

            {/* No summary yet â€” offer to generate */}
            {!summary && !isLoading && !error && (
                <div className={styles.action}>
                    <p className={styles.description}>
                        {postCount}ä»¶ã®ãƒ¬ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚<br />
                        NWWWã§è­°è«–ã®è¦ç‚¹ã‚’3è¡Œã«è¦ç´„ã—ã¾ã™ã€‚
                    </p>
                    <button onClick={handleSummarize} className={styles.button}>
                        è¦ç´„ã‚’ç”Ÿæˆã™ã‚‹
                    </button>
                </div>
            )}

            {/* Summary exists but collapsed */}
            {summary && !isOpen && !isLoading && (
                <div className={styles.action}>
                    <p className={styles.description}>
                        NWWWã«ã‚ˆã‚‹3è¡Œè¦ç´„ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚
                    </p>
                    <button onClick={() => setIsOpen(true)} className={styles.button}>
                        è¦ç´„ã‚’è¡¨ç¤ºã™ã‚‹
                    </button>
                </div>
            )}

            {/* Loading */}
            {isLoading && (
                <div className={styles.loading}>
                    <div className={styles.spinner}></div>
                    <p>NWWWãŒã‚¹ãƒ¬ãƒƒãƒ‰ã‚’åˆ†æä¸­...</p>
                </div>
            )}

            {/* Summary open */}
            {summary && isOpen && (
                <div className={styles.result}>
                    <ul className={styles.summaryList}>
                        {summary.split('\n').filter(line => line.trim()).map((line, index) => (
                            <li key={index} className={styles.summaryItem}>{line}</li>
                        ))}
                    </ul>
                    <div className={styles.meta}>
                        Generated by NWWW AI â€¢ {postCount}ãƒ¬ã‚¹æ™‚ç‚¹
                    </div>
                    <div className={styles.actions}>
                        <button onClick={handleSummarize} className={styles.refreshButton} disabled={isLoading}>
                            ğŸ”„ æœ€æ–°ã®è¦ç´„ã«æ›´æ–°
                        </button>
                        <button onClick={() => setIsOpen(false)} className={styles.closeButton}>
                            é–‰ã˜ã‚‹
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
}
